<!DOCTYPE html>
<html>
<head>
    <title>Highway VANET Simulation</title>
    <meta charset="UTF-8">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #0a0e27 0%, #1a1a2e 100%);
            color: #fff;
            padding: 15px;
        }
        #container {
            max-width: 1600px;
            margin: 0 auto;
        }
        h1 {
            text-align: center;
            background: linear-gradient(90deg, #00f2fe, #4facfe, #00f2fe);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: 32px;
            margin-bottom: 15px;
            text-shadow: 0 0 20px rgba(0,242,254,0.5);
        }
        canvas {
            background: #0a0e27;
            border: 3px solid #0ff;
            border-radius: 12px;
            display: block;
            margin: 15px auto;
            box-shadow: 0 0 40px rgba(0,255,255,0.4);
            max-width: 95%;
            height: auto;
        }
        #controls {
            background: rgba(255,255,255,0.05);
            backdrop-filter: blur(10px);
            padding: 20px;
            border-radius: 12px;
            margin: 15px 0;
            border: 1px solid rgba(0,255,255,0.2);
        }
        .btn-row {
            display: flex;
            gap: 12px;
            margin-bottom: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        button {
            background: linear-gradient(135deg, #00f2fe 0%, #4facfe 100%);
            color: #000;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
            transition: all 0.3s;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(79,172,254,0.5);
        }
        input[type="range"] {
            flex: 1;
            height: 8px;
            border-radius: 4px;
            background: rgba(255,255,255,0.2);
            outline: none;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #0ff;
            cursor: pointer;
            box-shadow: 0 0 10px rgba(0,255,255,0.6);
        }
        #stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 12px;
            margin: 15px 0;
        }
        .stat {
            background: rgba(0,255,255,0.1);
            padding: 12px;
            border-radius: 8px;
            border-left: 4px solid #0ff;
        }
        .stat-label {
            font-size: 11px;
            color: #aaa;
            text-transform: uppercase;
            margin-bottom: 5px;
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #0ff;
        }
        .legend {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
            margin: 15px 0;
            padding: 12px;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
        }
        .legend-dot {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            border: 2px solid #fff;
        }
        .legend-square {
            width: 14px;
            height: 14px;
            border-radius: 3px;
        }
        label {
            color: #aaa;
            margin-right: 10px;
            font-size: 14px;
        }
        .value {
            color: #0ff;
            font-weight: bold;
            min-width: 80px;
        }
        #loading {
            text-align: center;
            padding: 40px;
            font-size: 20px;
            color: #0ff;
        }
        .spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid rgba(0,255,255,0.3);
            border-top-color: #0ff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div id="container">
        <h1>ÔøΩÔ∏è Highway VANET Traffic Simulation üèéÔ∏èüö¶</h1>
        
        <div id="loading">
            <div class="spinner"></div>
            <div>Loading city simulation...</div>
        </div>
        
        <div id="content" style="display:none;">
            <div class="legend">
                <div class="legend-item">
                    <div class="legend-dot" style="background: #44ff44;"></div>
                    <span>Normal Vehicle</span>
                </div>
                <div class="legend-item">
                    <div class="legend-dot" style="background: #ff4444;"></div>
                    <span>Malicious</span>
                </div>
                <div class="legend-item">
                    <div class="legend-dot" style="background: #ffff44;"></div>
                    <span>Cluster Head</span>
                </div>
                <div class="legend-item">
                    <div class="legend-dot" style="background: #ff8800;"></div>
                    <span>Emergency</span>
                </div>
                <div class="legend-item">
                    <div class="legend-square" style="background: #ff0000;"></div>
                    <span>Red Light</span>
                </div>
                <div class="legend-item">
                    <div class="legend-square" style="background: #ffff00;"></div>
                    <span>Yellow Light</span>
                </div>
                <div class="legend-item">
                    <div class="legend-square" style="background: #00ff00;"></div>
                    <span>Green Light</span>
                </div>
            </div>
            
            <canvas id="canvas" width="1600" height="1600"></canvas>
            
            <div id="controls">
                <div class="btn-row">
                    <button id="playBtn">‚ñ∂Ô∏è Play</button>
                    <button id="resetBtn">üîÑ Reset</button>
                    <label>Speed:</label>
                    <input type="range" id="speedSlider" min="0.25" max="5" step="0.25" value="1">
                    <span class="value"><span id="speedVal">1.0</span>x</span>
                </div>
                <div class="btn-row">
                    <label>Timeline:</label>
                    <input type="range" id="timelineSlider" min="0" max="100" value="0">
                    <span class="value"><span id="timeVal">0.0</span>s / <span id="totalTime">60.0</span>s</span>
                </div>
            </div>
            
            <div id="stats">
                <div class="stat">
                    <div class="stat-label">üö¶ Intersections</div>
                    <div class="stat-value" id="intersections">0</div>
                </div>
                <div class="stat">
                    <div class="stat-label">üî¥ Clusters</div>
                    <div class="stat-value" id="clusters">0</div>
                </div>
                <div class="stat">
                    <div class="stat-label">üöó Vehicles</div>
                    <div class="stat-value" id="vehicles">0</div>
                </div>
                <div class="stat">
                    <div class="stat-label">üì§ Messages Sent</div>
                    <div class="stat-value" id="msgSent">0</div>
                </div>
                <div class="stat">
                    <div class="stat-label">üì• Msg Received</div>
                    <div class="stat-value" id="msgRecv">0</div>
                </div>
                <div class="stat">
                    <div class="stat-label">üó≥Ô∏è Head Elections</div>
                    <div class="stat-value" id="headElections">0</div>
                </div>
                <div class="stat">
                    <div class="stat-label">‚úÖ Consensus</div>
                    <div class="stat-value" id="consensusStatus">ON</div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        fetch('city_animation_data.json')
            .then(response => response.json())
            .then(data => {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('content').style.display = 'block';
                initAnimation(data);
            })
            .catch(error => {
                document.getElementById('loading').innerHTML = '‚ùå Error: ' + error.message;
                console.error(error);
            });
        
        function initAnimation(data) {
            console.log('City simulation loaded:', data.frames.length, 'frames');
            
            const canvas = document.getElementById('canvas');
            const ctx = canvas.getContext('2d');
            
            // Calculate scale to fit large city into canvas
            const cityWidth = 3300;
            const cityHeight = 3200;
            const scale = Math.min(canvas.width / cityWidth, canvas.height / cityHeight);
            
            console.log(`Scaling city from ${cityWidth}x${cityHeight} to fit canvas with scale: ${scale.toFixed(2)}`);
            
            let frame = 0;
            let playing = false;
            let speed = 1.0;
            const totalFrames = data.frames.length;
            
            document.getElementById('timelineSlider').max = totalFrames - 1;
            document.getElementById('totalTime').textContent = data.metadata.duration.toFixed(1);
            document.getElementById('intersections').textContent = data.intersections.length;
            
            const trails = {};
            
            function drawFrame(idx) {
                const frameData = data.frames[idx];
                
                // Clear
                ctx.fillStyle = '#0a0e27';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                // Save context and apply scaling
                ctx.save();
                ctx.scale(scale, scale);
                
                // Draw roads
                ctx.strokeStyle = 'rgba(100,100,100,0.6)';
                ctx.lineWidth = 40;
                ctx.lineCap = 'round';
                data.roads.forEach(road => {
                    ctx.beginPath();
                    ctx.moveTo(road.start_x, road.start_y);
                    ctx.lineTo(road.end_x, road.end_y);
                    ctx.stroke();
                });
                
                // Draw road lane markings
                ctx.strokeStyle = 'rgba(255,255,255,0.4)';
                ctx.lineWidth = 2;
                ctx.setLineDash([15, 10]);
                data.roads.forEach(road => {
                    ctx.beginPath();
                    ctx.moveTo(road.start_x, road.start_y);
                    ctx.lineTo(road.end_x, road.end_y);
                    ctx.stroke();
                });
                ctx.setLineDash([]);
                
                // Draw intersections
                data.intersections.forEach(inter => {
                    ctx.fillStyle = 'rgba(80,80,80,0.8)';
                    ctx.fillRect(inter.x - 60, inter.y - 60, 120, 120);
                    
                    // Intersection name (smaller for 11x11 grid)
                    ctx.fillStyle = 'rgba(255,255,255,0.5)';
                    ctx.font = 'bold 8px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText(inter.name, inter.x, inter.y - 70);
                });
                
                // Draw traffic lights
                frameData.traffic_lights.forEach(light => {
                    // Traffic light pole
                    ctx.fillStyle = '#333';
                    ctx.fillRect(light.x - 3, light.y - 25, 6, 25);
                    
                    // Light box
                    ctx.fillStyle = '#222';
                    ctx.fillRect(light.x - 8, light.y - 35, 16, 30);
                    
                    // Light color
                    const colors = {
                        'red': '#ff0000',
                        'yellow': '#ffff00',
                        'green': '#00ff00'
                    };
                    ctx.fillStyle = colors[light.state];
                    ctx.shadowBlur = 15;
                    ctx.shadowColor = colors[light.state];
                    ctx.beginPath();
                    ctx.arc(light.x, light.y - 20, 6, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.shadowBlur = 0;
                });
                
                // Draw clusters with consistent colors based on cluster ID hash
                frameData.clusters.forEach((cluster) => {
                    // Hash cluster ID to get consistent color
                    let hash = 0;
                    for (let i = 0; i < cluster.id.length; i++) {
                        hash = cluster.id.charCodeAt(i) + ((hash << 5) - hash);
                    }
                    const hue = Math.abs(hash % 360);
                    
                    ctx.strokeStyle = `hsla(${hue}, 70%, 60%, 0.7)`;
                    ctx.fillStyle = `hsla(${hue}, 70%, 60%, 0.08)`;
                    ctx.lineWidth = 2;
                    ctx.setLineDash([5, 5]);
                    ctx.beginPath();
                    ctx.arc(cluster.center_x, cluster.center_y, cluster.radius, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.stroke();
                    ctx.setLineDash([]);
                });
                
                // Draw vehicles
                frameData.vehicles.forEach(v => {
                    // Trail
                    if (!trails[v.id]) trails[v.id] = [];
                    trails[v.id].push({x: v.x, y: v.y});
                    if (trails[v.id].length > 25) trails[v.id].shift();
                    
                    let trailColor = v.is_emergency ? 'rgba(255,136,0,0.4)' :
                                    (v.is_malicious ? 'rgba(255,68,68,0.3)' : 'rgba(68,255,68,0.3)');
                    ctx.strokeStyle = trailColor;
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    trails[v.id].forEach((p, i) => {
                        if (i === 0) ctx.moveTo(p.x, p.y);
                        else ctx.lineTo(p.x, p.y);
                    });
                    ctx.stroke();
                    
                    // Vehicle body
                    const size = v.is_cluster_head ? 11 : 8;
                    let vColor = v.is_emergency ? '#ff8800' :
                                (v.is_cluster_head ? '#ffff44' :
                                (v.is_malicious ? '#ff4444' : '#44ff44'));
                    
                    ctx.fillStyle = vColor;
                    ctx.beginPath();
                    ctx.arc(v.x, v.y, size, 0, Math.PI * 2);
                    ctx.fill();
                    
                    // Border
                    ctx.strokeStyle = '#fff';
                    ctx.lineWidth = 2;
                    ctx.stroke();
                    
                    // Direction arrow
                    const arrowLen = v.is_emergency ? 20 : 15;
                    const angle = v.direction * Math.PI / 180;
                    ctx.strokeStyle = v.waiting ? '#ff0000' : '#ffffff';
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    ctx.moveTo(v.x, v.y);
                    ctx.lineTo(v.x + Math.cos(angle) * arrowLen, v.y + Math.sin(angle) * arrowLen);
                    ctx.stroke();
                    
                    // Stop indicator
                    if (v.waiting) {
                        ctx.fillStyle = 'rgba(255,0,0,0.4)';
                        ctx.beginPath();
                        ctx.arc(v.x, v.y, size + 5, 0, Math.PI * 2);
                        ctx.fill();
                    }
                });
                
                // Restore context
                ctx.restore();
                
                // Update stats
                document.getElementById('clusters').textContent = frameData.stats.total_clusters;
                document.getElementById('vehicles').textContent = frameData.stats.total_vehicles;
                document.getElementById('msgSent').textContent = frameData.stats.messages_sent;
                document.getElementById('msgRecv').textContent = frameData.stats.messages_received;
                document.getElementById('headElections').textContent = frameData.stats.head_elections || 0;
                document.getElementById('consensusStatus').textContent = frameData.stats.consensus_enabled ? 'ON' : 'OFF';
                document.getElementById('timeVal').textContent = frameData.time.toFixed(1);
                document.getElementById('timelineSlider').value = idx;
            }
            
            function animate() {
                if (!playing) return;
                drawFrame(frame);
                frame++;
                if (frame >= totalFrames) frame = 0;
                setTimeout(() => requestAnimationFrame(animate), (1000 / 30) / speed);
            }
            
            document.getElementById('playBtn').onclick = () => {
                playing = !playing;
                document.getElementById('playBtn').textContent = playing ? '‚è∏Ô∏è Pause' : '‚ñ∂Ô∏è Play';
                if (playing) animate();
            };
            
            document.getElementById('resetBtn').onclick = () => {
                frame = 0;
                Object.keys(trails).forEach(k => trails[k] = []);
                drawFrame(0);
            };
            
            document.getElementById('speedSlider').oninput = (e) => {
                speed = parseFloat(e.target.value);
                document.getElementById('speedVal').textContent = speed.toFixed(1);
            };
            
            document.getElementById('timelineSlider').oninput = (e) => {
                frame = parseInt(e.target.value);
                drawFrame(frame);
            };
            
            drawFrame(0);
        }
    </script>
</body>
</html>
